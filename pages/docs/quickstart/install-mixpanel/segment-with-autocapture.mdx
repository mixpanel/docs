import { Callout, Tabs } from "nextra/components";

import ExtendedButton from "/components/ExtendedButton/ExtendedButton";
import ExtendedTabs from "/components/ExtendedTabs/ExtendedTabs";

import { dataItems } from "/utils/constants";

# Setting up Autocapture with Segment

<Callout>Note: In most cases, we do not recommend implementing Autocapture with Segment to minimize the risks of identity management issues. Please consult with a member of our team if you choose to use this approach.</Callout>

It is possible to use Mixpanelâ€™s Autocapture in conjunction with Segment; the following tutorial will show you how to implement Autocapture on your website in a way that integrated with [**cloud mode](https://segment.com/docs/connections/sources/catalog/libraries/mobile/apple/cloud-mode-destinations/).**

The Segment SDK does not currently support an Autocapture mechanism, so the way to integrate is to load the Mixpanel Javascript SDK on your website, and then use a snippet which implements Segmentâ€™s middleware pattern to ensure that the user and device_ids match in the Segment and autocaptured data.

In this setup, the autocaptured event data will go directly to Mixpanel and will not pass through the Segment pipeline - however the userâ€™s identity will be kept in sync between both systems allowing you to have consistent user flows in Mixpanel that properly join autocaptured data and Segment tracked data.

In the following code snippet we:

- Embed the Segment SDK in our app
- Send an event (`app loaded`) to Segment; this event is forwarded to Mixpanel
- Emebed the Mixpanel SDK in our app
    - Activate Autocapture to track all track clicks
    - Ensure that Mixpanel, when loaded looks for Segmentâ€™s user and device_ids
- Register middleware with Segment to ensure that, when Segment loads, it propagates identity data to Mixpanel

<Callout>Important: the following snippet includes options for both simplified and original identity merge; please comment out the method you are not using.</Callout>

```HTML
<!DOCTYPE html>
<html>
<head>
	<title>segment + mixpanel autocapture</title>

	<!-- SEGMENT INSTALL (analytics.js) -->
	<script type="text/javascript">
		const SEGMENT_WRITE_KEY = `dHWN9FMfq2Ocmsjx4oAZQ48KQRrZrrl0`;
		!function () {
			var i = "analytics", analytics = window[i] = window[i] || []; if (!analytics.initialize) if (analytics.invoked) window.console && console.error && console.error("Segment snippet included twice."); else {
				analytics.invoked = !0; analytics.methods = ["trackSubmit", "trackClick", "trackLink", "trackForm", "pageview", "identify", "reset", "group", "track", "ready", "alias", "debug", "page", "screen", "once", "off", "on", "addSourceMiddleware", "addIntegrationMiddleware", "setAnonymousId", "addDestinationMiddleware", "register"]; analytics.factory = function (e) { return function () { if (window[i].initialized) return window[i][e].apply(window[i], arguments); var n = Array.prototype.slice.call(arguments); if (["track", "screen", "alias", "group", "page", "identify"].indexOf(e) > -1) { var c = document.querySelector("link[rel='canonical']"); n.push({ __t: "bpc", c: c && c.getAttribute("href") || void 0, p: location.pathname, u: location.href, s: location.search, t: document.title, r: document.referrer }); } n.unshift(e); analytics.push(n); return analytics; }; }; for (var n = 0; n < analytics.methods.length; n++) { var key = analytics.methods[n]; analytics[key] = analytics.factory(key); } analytics.load = function (key, n) { var t = document.createElement("script"); t.type = "text/javascript"; t.async = !0; t.setAttribute("data-global-segment-analytics-key", i); t.src = "https://cdn.segment.com/analytics.js/v1/" + key + "/analytics.min.js"; var r = document.getElementsByTagName("script")[0]; r.parentNode.insertBefore(t, r); analytics._loadOptions = n; }; analytics._writeKey = "RT8UgSD2nynW0HbEg6djCUWuEvD2kOQA";; analytics.SNIPPET_VERSION = "5.2.0";
				analytics.load(SEGMENT_WRITE_KEY);
				analytics.track('app loaded', { version: 1 }); // sample segment "track" event
				analytics.page('my page'); // sample segment "page" event
			}
		}();

		// ! IMPORTANT: tell Segment to propagate Ids to Mixpanel
		analytics.addSourceMiddleware(({ payload, next, integrations }) => {
			if (payload.obj.type === 'track' || payload.obj.type === 'page') {
				if (window.mixpanel) {
					const segmentDeviceId = payload.obj.anonymousId;
					// -------------------------------------------
					// Comment out one of the below mixpanel.register methods depending on your ID Management Version
					// Original ID Merge
					mixpanel.register({ $device_id: segmentDeviceId, distinct_id: segmentDeviceId });
					// Simplified ID Merge
					mixpanel.register({ $device_id: segmentDeviceId, distinct_id: "$device:" + segmentDeviceId });
					// -------------------------------------------	
				
				}
			}
			if (payload.obj.type === 'identify') {
				if (window.mixpanel) {
					const userId = payload.obj.userId;
					mixpanel.identify(userId);
				}
			}
			next(payload);
		});
	</script>
	<!-- MIXPANEL INSTALL -->
	<script type="text/javascript">
	const MIXPANEL_TOKEN = "0c1e0f968cd6b969ce6c84fe89c95830";
	(function (f, b) { if (!b.__SV) { var e, g, i, h; window.mixpanel = b; b._i = []; b.init = function (e, f, c) { function g(a, d) { var b = d.split("."); 2 == b.length && ((a = a[b[0]]), (d = b[1])); a[d] = function () { a.push([d].concat(Array.prototype.slice.call(arguments, 0))); }; } var a = b; "undefined" !== typeof c ? (a = b[c] = []) : (c = "mixpanel"); a.people = a.people || []; a.toString = function (a) { var d = "mixpanel"; "mixpanel" !== c && (d += "." + c); a || (d += " (stub)"); return d; }; a.people.toString = function () { return a.toString(1) + ".people (stub)"; }; i = "disable time_event track track_pageview track_links track_forms track_with_groups add_group set_group remove_group register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking start_batch_senders people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove".split(" "); for (h = 0; h < i.length; h++) g(a, i[h]); var j = "set set_once union unset remove delete".split(" "); a.get_group = function () { function b(c) { d[c] = function () { call2_args = arguments; call2 = [c].concat(Array.prototype.slice.call(call2_args, 0)); a.push([e, call2]); }; } for (var d = {}, e = ["get_group"].concat(Array.prototype.slice.call(arguments, 0)), c = 0; c < j.length; c++) b(j[c]); return d; }; b._i.push([e, f, c]); }; b.__SV = 1.2; e = f.createElement("script"); e.type = "text/javascript"; e.async = !0; e.src = "undefined" !== typeof MIXPANEL_CUSTOM_LIB_URL ? MIXPANEL_CUSTOM_LIB_URL : "file:" === f.location.protocol && "//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//) ? "https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js" : "//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js"; g = f.getElementsByTagName("script")[0]; g.parentNode.insertBefore(e, g); } })(document, window.mixpanel || []);

	mixpanel.init(MIXPANEL_TOKEN, {
		autocapture: true,
		// ! IMPORTANT: tell Mixpanel to look for Segment's device ID
		loaded: function (mixpanel) {
			if (analytics && analytics.user) {
				const segmentDeviceId = analytics.user().anonymousId()
				if (segmentDeviceId) {
					// Comment out one of the below mixpanel.register methods depending on your ID Management Version
					// Original ID Merge
					mixpanel.register({ $device_id: segmentDeviceId, distinct_id: segmentDeviceId });
					// Simplified ID Merge
					mixpanel.register({ $device_id: segmentDeviceId });
				}
				const segmentUserId = analytics.user().id()
				if (segmentUserId) {
					mixpanel.identify(segmentUserId);
				}
			}
		}
	});
	</script>
</head>

<body>
	<h1>ðŸ‘‹ hello segment + autocapture!</h1>
	<div class="buttons">
		<button id="clickMeButton">click me</button>
		<button id="dontClickMeButton">don't click me</button>
	</div>
</body>
</html>
```
